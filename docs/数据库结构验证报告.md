# 数据库结构验证报告

## 概述

本报告验证数据库表结构是否支持 XMind 中列出的所有功能模块。数据库结构文件：`src/main/resources/data/jredmine.sql`

## 验证结果总览

| 功能模块 | 数据库支持 | 主要表 | 支持程度 |
|---------|-----------|--------|---------|
| 项目管理 | ✅ | `projects`, `members` | 完整 |
| 任务管理 | ✅ | `issues`, `issue_*` | 完整 |
| 甘特图 | ✅ | `issues`, `issue_relations` | 完整 |
| Wiki | ✅ | `wikis`, `wiki_*` | 完整 |
| 论坛 | ✅ | `boards`, `messages` | 完整 |
| 文档管理 | ✅ | `documents` | 完整 |
| 文件管理 | ✅ | `attachments` | 完整 |
| 时间跟踪 | ✅ | `time_entries` | 完整 |
| 版本管理 | ✅ | `versions` | 完整 |
| 代码仓库集成 | ✅ | `repositories`, `changesets` | 完整 |
| 电子邮件通知 | ✅ | `email_addresses`, `journals` | 完整 |
| REST API | ✅ | `tokens` | 部分 |
| 角色与权限 | ✅ | `roles`, `workflows` | 完整 |
| 插件系统 | ⚠️ | - | 需扩展 |
| 多语言支持 | ✅ | `users.language` | 部分 |
| **用户管理** | ✅ | `users`, `email_addresses` | 完整 |
| **系统设置** | ✅ | `settings` | 完整 |
| **活动流** | ✅ | `journals`, `journal_details` | 完整 |
| **搜索功能** | ✅ | `queries` | 完整 |
| **自定义字段** | ✅ | `custom_fields` | 完整 |
| **工作流** | ✅ | `workflows` | 完整 |

## 详细验证

### 1. 项目管理模块

**相关表：**
- `projects` - 项目主表
- `members` - 项目成员
- `member_roles` - 成员角色
- `enabled_modules` - 项目启用的模块
- `projects_trackers` - 项目跟踪器关联

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
projects:
- id: 主键
- name: 项目名称
- parent_id: 父项目ID（支持子项目）
- lft, rgt: 树形结构支持
- status: 项目状态
- inherit_members: 继承成员
```

### 2. 任务管理模块

**相关表：**
- `issues` - 任务主表
- `issue_statuses` - 任务状态
- `issue_relations` - 任务关联
- `issue_categories` - 任务分类
- `trackers` - 跟踪器
- `watchers` - 关注者
- `journals` - 活动日志
- `journal_details` - 活动详情

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
issues:
- id: 主键
- tracker_id: 跟踪器
- project_id: 项目ID
- status_id: 状态ID
- priority_id: 优先级ID
- assigned_to_id: 分配给
- parent_id, root_id: 父子任务支持
- lft, rgt: 树形结构
- start_date, due_date: 时间范围
- done_ratio: 完成度
- estimated_hours: 预估工时
```

### 3. 时间跟踪模块

**相关表：**
- `time_entries` - 工时记录
- `enumerations` - 活动类型（type='TimeEntryActivity'）

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
time_entries:
- id: 主键
- project_id: 项目ID
- issue_id: 任务ID
- user_id: 用户ID
- hours: 工时
- spent_on: 日期
- tyear, tmonth, tweek: 时间维度（支持统计）
- activity_id: 活动类型
```

### 4. 版本管理模块

**相关表：**
- `versions` - 版本/里程碑

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
versions:
- id: 主键
- project_id: 项目ID
- name: 版本名称
- effective_date: 发布日期
- status: 状态（open/closed/locked）
- sharing: 共享范围
```

### 5. Wiki 模块

**相关表：**
- `wikis` - Wiki 主表
- `wiki_pages` - Wiki 页面
- `wiki_contents` - Wiki 内容
- `wiki_content_versions` - 版本历史
- `wiki_redirects` - 重定向

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
wikis:
- id: 主键
- project_id: 项目ID
- start_page: 起始页

wiki_content_versions:
- version: 版本号
- data: 内容数据（支持版本历史）
```

### 6. 论坛模块

**相关表：**
- `boards` - 论坛板块
- `messages` - 消息/主题
- `comments` - 评论

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
boards:
- id: 主键
- project_id: 项目ID
- name: 板块名称
- position: 排序

messages:
- id: 主键
- board_id: 板块ID
- parent_id: 父消息（支持回复）
- subject: 主题
- locked, sticky: 锁定/置顶
```

### 7. 文档管理模块

**相关表：**
- `documents` - 文档

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
documents:
- id: 主键
- project_id: 项目ID
- category_id: 分类ID
- title: 标题
- description: 描述
```

### 8. 文件管理模块

**相关表：**
- `attachments` - 附件

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
attachments:
- id: 主键
- container_type, container_id: 多态关联（支持关联到不同实体）
- filename: 文件名
- disk_filename: 磁盘文件名
- filesize: 文件大小
- content_type: 内容类型
- downloads: 下载次数
```

### 9. 代码仓库集成模块

**相关表：**
- `repositories` - 仓库配置
- `changesets` - 提交记录
- `changes` - 变更详情
- `changeset_parents` - 提交父节点
- `changesets_issues` - 提交与任务关联

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
repositories:
- id: 主键
- project_id: 项目ID
- type: 仓库类型（Git/SVN/Mercurial）
- url: 仓库地址

changesets:
- id: 主键
- repository_id: 仓库ID
- revision: 版本号
- committed_on: 提交时间
- comments: 提交说明
```

### 10. 角色与权限模块

**相关表：**
- `roles` - 角色
- `member_roles` - 成员角色
- `workflows` - 工作流
- `roles_managed_roles` - 角色管理关系

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
roles:
- id: 主键
- name: 角色名称
- permissions: 权限（JSON格式）
- issues_visibility: 任务可见性
- users_visibility: 用户可见性

workflows:
- tracker_id: 跟踪器
- old_status_id, new_status_id: 状态转换
- role_id: 角色
- field_name, rule: 字段规则
```

### 11. 自定义字段模块

**相关表：**
- `custom_fields` - 自定义字段
- `custom_values` - 字段值
- `custom_fields_projects` - 字段与项目关联
- `custom_fields_trackers` - 字段与跟踪器关联
- `custom_fields_roles` - 字段与角色关联
- `custom_field_enumerations` - 枚举值

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
custom_fields:
- id: 主键
- type: 字段类型（IssueCustomField等）
- name: 字段名称
- field_format: 字段格式（string/int/date等）
- is_required: 是否必填
- is_for_all: 是否适用于所有
```

### 12. 查询/搜索模块

**相关表：**
- `queries` - 查询
- `queries_roles` - 查询与角色关联

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
queries:
- id: 主键
- project_id: 项目ID（NULL表示全局）
- name: 查询名称
- filters: 过滤条件（JSON）
- column_names: 列名
- sort_criteria: 排序条件
- visibility: 可见性
```

### 13. 活动流模块

**相关表：**
- `journals` - 活动日志
- `journal_details` - 活动详情

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
journals:
- id: 主键
- journalized_type, journalized_id: 多态关联
- user_id: 用户ID
- notes: 备注
- created_on: 创建时间

journal_details:
- journal_id: 日志ID
- property: 属性类型
- prop_key: 属性键
- old_value, value: 旧值和新值
```

### 14. 系统设置模块

**相关表：**
- `settings` - 系统设置

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
settings:
- id: 主键
- name: 设置名称
- value: 设置值（TEXT类型，支持复杂配置）
```

### 15. 用户管理模块

**相关表：**
- `users` - 用户
- `email_addresses` - 邮箱地址
- `user_preferences` - 用户偏好
- `groups_users` - 用户组关联
- `auth_sources` - 认证源（LDAP等）

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
users:
- id: 主键
- login: 登录名
- hashed_password: 密码哈希
- status: 状态（1=活跃，2=锁定等）
- admin: 是否管理员
- twofa_*: 双因素认证字段
- auth_source_id: 认证源ID

email_addresses:
- user_id: 用户ID
- address: 邮箱地址
- is_default: 是否默认
- notify: 是否接收通知
```

### 16. 导入/导出模块

**相关表：**
- `imports` - 导入任务
- `import_items` - 导入项

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
imports:
- id: 主键
- type: 导入类型
- user_id: 用户ID
- filename: 文件名
- settings: 设置（JSON）
- total_items: 总项数
- finished: 是否完成
```

### 17. 通知模块

**相关表：**
- `email_addresses` - 邮箱地址
- `users.mail_notification` - 通知偏好
- `members.mail_notification` - 项目通知偏好

**验证结果：** ✅ 完整支持

### 18. 令牌管理（API认证）

**相关表：**
- `tokens` - 令牌

**验证结果：** ✅ 完整支持

**关键字段：**
```sql
tokens:
- id: 主键
- user_id: 用户ID
- action: 操作类型（api等）
- value: 令牌值
```

## 数据库结构优势

1. **完整性**: 覆盖了 Redmine 的所有核心功能
2. **扩展性**: 支持自定义字段、工作流等扩展
3. **关联性**: 表之间关联关系设计合理
4. **多态支持**: `attachments`, `journals` 等表支持多态关联
5. **树形结构**: `projects`, `issues` 等表支持树形结构（lft/rgt）
6. **版本控制**: Wiki 和附件支持版本历史

## 数据库结构建议

### 1. 索引优化

建议检查以下字段是否有索引：
- `issues.created_on` - ✅ 已有
- `time_entries.spent_on` - ⚠️ 建议添加
- `journals.created_on` - ✅ 已有
- `projects.status` - ⚠️ 建议添加

### 2. 分区策略

对于大数据量表，考虑分区：
- `journals` - 按时间分区
- `time_entries` - 按时间分区
- `attachments` - 按项目分区

### 3. 归档策略

考虑历史数据归档：
- 已关闭项目的任务
- 超过1年的活动日志
- 已删除的附件

## 总结

**数据库结构验证结果：** ✅ **优秀**

- 所有核心功能模块都有完整的数据库支持
- 表结构设计合理，支持复杂的业务场景
- 扩展性良好，支持自定义字段、工作流等
- 建议进行索引优化和分区策略规划

