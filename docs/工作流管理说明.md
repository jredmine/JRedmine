# 工作流管理说明

## 📖 什么是工作流（Workflow）？

**工作流（Workflow）** 是定义任务（Issue）状态转换规则的系统。它控制：
- **哪些角色**可以将任务从**某个状态**转换到**另一个状态**
- **哪些字段**在状态转换时**必须填写**或**只读**
- **权限控制**：只有特定角色才能执行特定的状态转换

## 🎯 核心概念

### 1. 任务状态（Issue Status）

任务在生命周期中会经历不同的状态，例如：
- **新建（New）** - 任务刚创建
- **进行中（In Progress）** - 任务正在处理
- **已解决（Resolved）** - 任务已解决，等待验证
- **已关闭（Closed）** - 任务已完成并关闭
- **已拒绝（Rejected）** - 任务被拒绝

### 2. 跟踪器（Tracker）

跟踪器用于分类任务类型，例如：
- **Bug** - 缺陷报告
- **Feature** - 功能需求
- **Support** - 技术支持
- **Task** - 普通任务

### 3. 工作流规则

工作流定义了：
- **状态转换规则**：从状态A可以转换到状态B
- **角色权限**：哪些角色可以执行这个转换
- **字段规则**：转换时字段的必填/只读规则
- **用户限制**：是否只有创建者或指派人可以执行

## 🔄 工作流的工作原理

### 状态转换示例

假设有一个 Bug 跟踪器，工作流规则如下：

```
Bug 跟踪器的工作流：
├─ 新建 → 进行中（开发者角色）
├─ 进行中 → 已解决（开发者角色）
├─ 已解决 → 已关闭（测试人员角色）
├─ 已解决 → 进行中（测试人员角色，如果测试失败）
└─ 新建 → 已拒绝（项目经理角色）
```

### 字段规则示例

在状态转换时，可以定义字段规则：

```
从"新建"转换到"进行中"时：
- assigned_to（指派人）：必填
- priority（优先级）：可编辑
- description（描述）：只读

从"已解决"转换到"已关闭"时：
- resolution（解决方案）：必填
- done_ratio（完成度）：自动设置为100%
```

## 💼 使用场景

### 场景1：软件开发流程

**Bug 处理流程**：
```
1. 测试人员创建 Bug（状态：新建）
   ↓
2. 开发人员认领并开始修复（状态：进行中）
   ↓
3. 开发人员修复完成（状态：已解决）
   ↓
4. 测试人员验证（状态：已关闭 或 进行中）
```

**工作流配置**：
- 只有"开发者"角色可以将"新建"→"进行中"
- 只有"开发者"角色可以将"进行中"→"已解决"
- 只有"测试人员"角色可以将"已解决"→"已关闭"
- 只有"测试人员"角色可以将"已解决"→"进行中"（重新打开）

### 场景2：需求管理流程

**Feature 处理流程**：
```
1. 产品经理创建需求（状态：新建）
   ↓
2. 开发团队评估（状态：评估中）
   ↓
3. 开发团队开始开发（状态：开发中）
   ↓
4. 开发完成（状态：待测试）
   ↓
5. 测试通过（状态：已完成）
```

**工作流配置**：
- 只有"产品经理"角色可以将"新建"→"评估中"
- 只有"开发负责人"角色可以将"评估中"→"开发中"
- 只有"开发者"角色可以将"开发中"→"待测试"
- 只有"测试人员"角色可以将"待测试"→"已完成"

### 场景3：权限精细化控制

**场景**：只有任务的创建者或指派人可以关闭任务

**工作流配置**：
- 状态转换：进行中 → 已关闭
- 角色：开发者
- 用户限制：`author = true` 或 `assignee = true`
  - 只有创建者（author）或指派人（assignee）可以执行此转换

## 📊 数据库结构

### workflows 表

```sql
CREATE TABLE `workflows` (
  `id` int NOT NULL AUTO_INCREMENT,
  `tracker_id` int NOT NULL DEFAULT '0',        -- 跟踪器ID（0表示所有跟踪器）
  `old_status_id` int NOT NULL DEFAULT '0',    -- 旧状态ID（0表示所有状态）
  `new_status_id` int NOT NULL DEFAULT '0',    -- 新状态ID
  `role_id` int NOT NULL DEFAULT '0',          -- 角色ID（0表示所有角色）
  `assignee` tinyint(1) NOT NULL DEFAULT '0', -- 是否只有指派人可以执行
  `author` tinyint(1) NOT NULL DEFAULT '0',    -- 是否只有创建者可以执行
  `type` varchar(30) DEFAULT NULL,             -- 类型（'transition'=状态转换，'field'=字段规则）
  `field_name` varchar(30) DEFAULT NULL,       -- 字段名（用于字段规则）
  `rule` varchar(30) DEFAULT NULL,             -- 规则（'required'=必填，'readonly'=只读，'hidden'=隐藏）
  PRIMARY KEY (`id`)
)
```

### 字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| `tracker_id` | 跟踪器ID，0表示所有跟踪器 | `1`（Bug）或 `0`（所有） |
| `old_status_id` | 源状态ID，0表示所有状态 | `1`（新建）或 `0`（所有） |
| `new_status_id` | 目标状态ID | `2`（进行中） |
| `role_id` | 角色ID，0表示所有角色 | `3`（开发者）或 `0`（所有） |
| `assignee` | 是否只有指派人可以执行 | `true` 或 `false` |
| `author` | 是否只有创建者可以执行 | `true` 或 `false` |
| `type` | 规则类型 | `'transition'`（状态转换）或 `'field'`（字段规则） |
| `field_name` | 字段名（仅用于字段规则） | `'assigned_to'`、`'priority'` |
| `rule` | 规则（仅用于字段规则） | `'required'`（必填）、`'readonly'`（只读） |

## 🔧 工作流类型

### 1. 状态转换规则（Transition）

定义哪些角色可以将任务从某个状态转换到另一个状态。

**示例**：
```sql
-- Bug 跟踪器：开发者角色可以将"新建"转换为"进行中"
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type)
VALUES (1, 1, 2, 3, 'transition');
```

### 2. 字段规则（Field）

定义在状态转换时，字段的必填、只读或隐藏规则。

**示例**：
```sql
-- Bug 跟踪器：从"新建"转换到"进行中"时，"指派人"字段必填
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type, field_name, rule)
VALUES (1, 1, 2, 3, 'field', 'assigned_to', 'required');

-- Bug 跟踪器：从"新建"转换到"进行中"时，"描述"字段只读
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type, field_name, rule)
VALUES (1, 1, 2, 3, 'field', 'description', 'readonly');
```

## 🎨 实际应用示例

### 示例1：完整的 Bug 处理工作流

```sql
-- 1. 状态转换规则

-- 开发者可以将"新建"转换为"进行中"
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type)
VALUES (1, 1, 2, 3, 'transition');

-- 开发者可以将"进行中"转换为"已解决"
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type)
VALUES (1, 2, 3, 3, 'transition');

-- 测试人员可以将"已解决"转换为"已关闭"
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type)
VALUES (1, 3, 4, 4, 'transition');

-- 测试人员可以将"已解决"转换为"进行中"（重新打开）
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type)
VALUES (1, 3, 2, 4, 'transition');

-- 2. 字段规则

-- 从"新建"到"进行中"：指派人必填
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type, field_name, rule)
VALUES (1, 1, 2, 3, 'field', 'assigned_to', 'required');

-- 从"已解决"到"已关闭"：解决方案必填
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type, field_name, rule)
VALUES (1, 3, 4, 4, 'field', 'resolution', 'required');
```

### 示例2：只有创建者可以关闭任务

```sql
-- 只有创建者可以将"进行中"转换为"已关闭"
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type, author)
VALUES (1, 2, 4, 3, 'transition', 1);
```

### 示例3：只有指派人可以解决任务

```sql
-- 只有指派人可以将"进行中"转换为"已解决"
INSERT INTO workflows (tracker_id, old_status_id, new_status_id, role_id, type, assignee)
VALUES (1, 2, 3, 3, 'transition', 1);
```

## 🚀 工作流的优势

1. **权限精细化控制**：不同角色有不同的操作权限
2. **流程标准化**：确保任务按照既定流程处理
3. **数据完整性**：通过必填规则确保关键信息不缺失
4. **灵活性**：可以为不同的跟踪器配置不同的工作流
5. **可扩展性**：支持复杂的业务规则（创建者、指派人限制等）

## 📝 工作流管理功能

需要实现以下功能：

1. **查询工作流规则**
   - 按跟踪器查询
   - 按角色查询
   - 按状态查询

2. **创建/更新工作流规则**
   - 状态转换规则
   - 字段规则

3. **删除工作流规则**
   - 删除单个规则
   - 批量删除规则

4. **工作流验证**
   - 验证状态转换是否允许
   - 验证字段规则（必填、只读等）

5. **工作流可视化**
   - 显示状态转换图
   - 显示可用的状态转换

## 🔗 相关概念

- **跟踪器（Tracker）**：任务分类（Bug、Feature等）
- **任务状态（Issue Status）**：任务的生命周期状态
- **角色（Role）**：项目成员的角色，决定权限
- **任务（Issue）**：项目中的具体任务/问题

